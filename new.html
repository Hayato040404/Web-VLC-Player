<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ğŸ¬ M3U Player Pro - ç©¶æ¥µã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä½“é¨“</title>
<style>
  /* ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  
  :root {
    --primary-color: #007aff;
    --secondary-color: #34c759;
    --accent-color: #ff9500;
    --danger-color: #ff3b30;
    --background-primary: #f2f2f7;
    --background-secondary: #ffffff;
    --text-primary: #1c1c1e;
    --text-secondary: #8e8e93;
    --border-color: #d1d1d6;
    --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
    --shadow-medium: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-heavy: 0 8px 24px rgba(0,0,0,0.15);
    --border-radius: 16px;
    --border-radius-large: 24px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  html, body {
    height: 100%;
    background: var(--background-primary);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    background: var(--background-secondary);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 16px 20px;
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
  }

  .logo {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* æ¤œç´¢ãƒãƒ¼ */
  .search-container {
    position: relative;
    flex: 1;
    max-width: 400px;
    margin: 0 20px;
  }

  .search-input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-secondary);
    font-size: 1rem;
    transition: var(--transition);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
  .btn {
    padding: 10px 16px;
    border-radius: var(--border-radius);
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-light);
  }

  .btn-primary:hover {
    background: #005ecb;
    box-shadow: var(--shadow-medium);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--background-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .btn-secondary:hover {
    background: #f8f8f8;
    border-color: var(--primary-color);
  }

  .btn-success {
    background: var(--secondary-color);
    color: white;
  }

  .btn-success:hover {
    background: #28a745;
  }

  /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */
  .file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
  }

  .file-input {
    position: absolute;
    left: -9999px;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .main-content {
    flex: 1;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
    padding: 20px;
  }

  /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .player-section {
    background: var(--background-secondary);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-medium);
    margin-bottom: 24px;
    overflow: hidden;
  }

  .player-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .now-playing {
    flex: 1;
  }

  .now-playing-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .now-playing-info {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .player-controls {
    display: flex;
    gap: 8px;
  }

  .video-container {
    position: relative;
    background: #000;
  }

  .video-player {
    width: 100%;
    height: auto;
    min-height: 300px;
    display: block;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    opacity: 0;
    transition: var(--transition);
    pointer-events: none;
  }

  .video-overlay.show {
    opacity: 1;
  }

  /* ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .playlist-section {
    background: var(--background-secondary);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-medium);
    overflow: hidden;
  }

  .playlist-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .playlist-title {
    font-size: 1.3rem;
    font-weight: 700;
  }

  .playlist-stats {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .playlist-filters {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .filter-chip {
    padding: 6px 12px;
    border-radius: 20px;
    background: var(--background-primary);
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    cursor: pointer;
    transition: var(--transition);
  }

  .filter-chip.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .filter-chip:hover:not(.active) {
    background: #e8e8ed;
  }

  /* ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
  .playlist-content {
    max-height: 600px;
    overflow-y: auto;
  }

  .playlist-group {
    border-bottom: 1px solid var(--border-color);
  }

  .group-header {
    padding: 16px 24px;
    background: var(--background-primary);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .group-toggle {
    transition: var(--transition);
  }

  .group-header.collapsed .group-toggle {
    transform: rotate(-90deg);
  }

  .group-items {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    padding: 16px 24px;
  }

  .group-items.collapsed {
    display: none;
  }

  .playlist-item {
    background: var(--background-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .playlist-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-color);
  }

  .playlist-item.playing {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
  }

  .item-thumbnail {
    width: 100%;
    height: 120px;
    object-fit: cover;
    background: var(--background-primary);
  }

  .item-content {
    padding: 12px;
  }

  .item-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 4px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .item-group {
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-bottom: 8px;
  }

  .item-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .item-action {
    padding: 4px 8px;
    border-radius: 8px;
    border: none;
    background: var(--background-primary);
    color: var(--text-secondary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: var(--transition);
  }

  .item-action:hover {
    background: var(--primary-color);
    color: white;
  }

  .item-action.active {
    background: var(--accent-color);
    color: white;
  }

  /* ç©ºã®çŠ¶æ…‹ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .empty-description {
    font-size: 0.9rem;
    line-height: 1.5;
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-color);
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 12px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--background-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 16px 20px;
    box-shadow: var(--shadow-heavy);
    z-index: 1000;
    transform: translateX(400px);
    transition: var(--transition);
    max-width: 300px;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .toast-icon {
    font-size: 1.2rem;
  }

  .toast-message {
    flex: 1;
    font-size: 0.9rem;
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1rem;
  }

  /* ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« */
  .debug-console {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 400px;
    max-height: 300px;
    background: #1a1a1a;
    color: #00ff00;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 0.8rem;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-heavy);
    z-index: 999;
    transform: translateY(400px);
    transition: var(--transition);
  }

  .debug-console.show {
    transform: translateY(0);
  }

  .debug-header {
    background: #333;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
  }

  .debug-content {
    padding: 12px;
    max-height: 240px;
    overflow-y: auto;
    white-space: pre-wrap;
    line-height: 1.4;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      gap: 12px;
    }

    .search-container {
      order: 3;
      max-width: none;
      margin: 0;
    }

    .header-actions {
      order: 2;
      width: 100%;
      justify-content: space-between;
    }

    .main-content {
      padding: 16px;
    }

    .group-items {
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 12px 16px;
    }

    .playlist-header,
    .player-header {
      padding: 16px;
    }

    .playlist-filters {
      padding: 12px 16px;
    }

    .debug-console {
      width: calc(100vw - 40px);
      left: 20px;
      right: 20px;
    }

    .toast {
      right: 20px;
      left: 20px;
      max-width: none;
    }
  }

  @media (max-width: 480px) {
    .btn {
      padding: 8px 12px;
      font-size: 0.8rem;
    }

    .logo {
      font-size: 1.3rem;
    }

    .playlist-title {
      font-size: 1.1rem;
    }

    .item-content {
      padding: 10px;
    }
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <div class="logo">
      ğŸ¬ M3U Player Pro
    </div>
    
    <div class="search-container">
      <div class="search-icon">ğŸ”</div>
      <input type="text" class="search-input" id="searchInput" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ¤œç´¢..." />
    </div>
    
    <div class="header-actions">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" class="file-input" accept=".m3u,.m3u8" />
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
          ğŸ“ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
        </button>
      </div>
      
      <button class="btn btn-secondary" id="debugToggle">
        ğŸ› ãƒ‡ãƒãƒƒã‚°
      </button>
      
      <button class="btn btn-success" id="premiumUnlock">
        ğŸ” ãƒ—ãƒ¬ãƒŸã‚¢ãƒ 
      </button>
    </div>
  </div>
</header>

<main class="main-content">
  <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section class="player-section">
    <div class="player-header">
      <div class="now-playing">
        <div class="now-playing-title" id="nowPlayingTitle">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
        <div class="now-playing-info" id="nowPlayingInfo">ãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã™ã‚‹ã¨å†ç”ŸãŒé–‹å§‹ã•ã‚Œã¾ã™</div>
      </div>
      <div class="player-controls">
        <button class="btn btn-secondary" id="pipButton" title="ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¤ãƒ³ãƒ”ã‚¯ãƒãƒ£ãƒ¼">
          ğŸ“º PIP
        </button>
        <button class="btn btn-secondary" id="fullscreenButton" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³">
          â›¶ å…¨ç”»é¢
        </button>
      </div>
    </div>
    
    <div class="video-container">
      <video id="videoPlayer" class="video-player" controls preload="auto" playsinline></video>
      <div class="video-overlay" id="videoOverlay">
        <div>ğŸ“º ãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã—ã¦å†ç”Ÿã‚’é–‹å§‹</div>
      </div>
    </div>
  </section>

  <!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section class="playlist-section">
    <div class="playlist-header">
      <div>
        <div class="playlist-title">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</div>
        <div class="playlist-stats" id="playlistStats">ãƒãƒ£ãƒ³ãƒãƒ«æ•°: 0</div>
      </div>
    </div>
    
    <div class="playlist-filters" id="playlistFilters" style="display: none;">
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒƒãƒ—ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
    </div>
    
    <div class="playlist-content" id="playlistContent">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“º</div>
        <div class="empty-title">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç©ºã§ã™</div>
        <div class="empty-description">
          M3Uãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãŠæ°—ã«å…¥ã‚Šã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼<br>
          ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šéƒ¨ã®ã€Œãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
<div class="toast" id="toast">
  <div class="toast-content">
    <div class="toast-icon" id="toastIcon">â„¹ï¸</div>
    <div class="toast-message" id="toastMessage"></div>
    <button class="toast-close" onclick="hideToast()">Ã—</button>
  </div>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
<div class="debug-console" id="debugConsole">
  <div class="debug-header">
    <span>ğŸ› ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
    <button class="toast-close" onclick="toggleDebug()" style="color: #fff;">Ã—</button>
  </div>
  <div class="debug-content" id="debugContent"></div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentPlaylist = [];
let filteredPlaylist = [];
let currentVideo = null;
let premium = localStorage.getItem('premium') === 'true';
let debug = false;
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
let pins = JSON.parse(localStorage.getItem('pins') || '[]');
let collapsedGroups = new Set();

// DOMè¦ç´ 
const elements = {
  fileInput: document.getElementById('fileInput'),
  searchInput: document.getElementById('searchInput'),
  debugToggle: document.getElementById('debugToggle'),
  premiumUnlock: document.getElementById('premiumUnlock'),
  pipButton: document.getElementById('pipButton'),
  fullscreenButton: document.getElementById('fullscreenButton'),
  videoPlayer: document.getElementById('videoPlayer'),
  videoOverlay: document.getElementById('videoOverlay'),
  nowPlayingTitle: document.getElementById('nowPlayingTitle'),
  nowPlayingInfo: document.getElementById('nowPlayingInfo'),
  playlistContent: document.getElementById('playlistContent'),
  playlistStats: document.getElementById('playlistStats'),
  playlistFilters: document.getElementById('playlistFilters'),
  toast: document.getElementById('toast'),
  toastIcon: document.getElementById('toastIcon'),
  toastMessage: document.getElementById('toastMessage'),
  debugConsole: document.getElementById('debugConsole'),
  debugContent: document.getElementById('debugContent')
};

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function log(message, type = 'info') {
  if (!debug) return;
  
  const timestamp = new Date().toLocaleTimeString();
  const icons = { info: 'â„¹ï¸', success: 'âœ…', warning: 'âš ï¸', error: 'âŒ' };
  const icon = icons[type] || icons.info;
  
  elements.debugContent.textContent += `[${timestamp}] ${icon} ${message}\n`;
  elements.debugContent.scrollTop = elements.debugContent.scrollHeight;
}

function showToast(message, type = 'info', duration = 3000) {
  const icons = { info: 'â„¹ï¸', success: 'âœ…', warning: 'âš ï¸', error: 'âŒ' };
  
  elements.toastIcon.textContent = icons[type] || icons.info;
  elements.toastMessage.textContent = message;
  elements.toast.classList.add('show');
  
  setTimeout(() => {
    elements.toast.classList.remove('show');
  }, duration);
  
  log(message, type);
}

function hideToast() {
  elements.toast.classList.remove('show');
}

function toggleDebug() {
  debug = !debug;
  elements.debugConsole.classList.toggle('show', debug);
  elements.debugToggle.textContent = debug ? 'ğŸ› ãƒ‡ãƒãƒƒã‚° OFF' : 'ğŸ› ãƒ‡ãƒãƒƒã‚°';
  
  if (debug) {
    log('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
  }
}

// ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè§£æ
function parseM3U(content) {
  const lines = content.split('\n').map(line => line.trim()).filter(line => line);
  const channels = [];
  let currentChannel = {};
  
  log('M3Uãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã‚’é–‹å§‹');
  
  for (const line of lines) {
    if (line.startsWith('#EXTINF:')) {
      // ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ã®æŠ½å‡º
      const titleMatch = line.match(/,(.+)$/);
      const logoMatch = line.match(/tvg-logo="([^"]+)"/);
      const groupMatch = line.match(/group-title="([^"]+)"/);
      const idMatch = line.match(/tvg-id="([^"]+)"/);
      
      currentChannel = {
        id: idMatch ? idMatch[1] : `channel_${channels.length}`,
        title: titleMatch ? titleMatch[1].trim() : `ãƒãƒ£ãƒ³ãƒãƒ« ${channels.length + 1}`,
        logo: logoMatch ? logoMatch[1] : 'https://via.placeholder.com/160x90/007aff/ffffff?text=ğŸ“º',
        group: groupMatch ? groupMatch[1] : 'æœªåˆ†é¡',
        url: ''
      };
    } else if (line.startsWith('http')) {
      currentChannel.url = line;
      channels.push({ ...currentChannel });
      currentChannel = {};
    }
  }
  
  currentPlaylist = channels;
  filteredPlaylist = [...channels];
  
  log(`${channels.length}å€‹ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
  showToast(`${channels.length}å€‹ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
  
  renderPlaylist();
  updateStats();
  createFilters();
}

// ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè¡¨ç¤º
function renderPlaylist() {
  if (filteredPlaylist.length === 0) {
    elements.playlistContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <div class="empty-title">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
        <div class="empty-description">
          æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
    `;
    return;
  }
  
  // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«æ•´ç†
  const groups = {};
  
  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½: ãƒ”ãƒ³ç•™ã‚ã¨ãŠæ°—ã«å…¥ã‚Š
  if (premium) {
    const pinnedChannels = filteredPlaylist.filter(channel => 
      pins.some(pin => pin.id === channel.id)
    );
    const favoriteChannels = filteredPlaylist.filter(channel => 
      favorites.some(fav => fav.id === channel.id)
    );
    
    if (pinnedChannels.length > 0) {
      groups['ğŸ“Œ ãƒ”ãƒ³ç•™ã‚'] = pinnedChannels;
    }
    if (favoriteChannels.length > 0) {
      groups['â­ ãŠæ°—ã«å…¥ã‚Š'] = favoriteChannels;
    }
  }
  
  // é€šå¸¸ã®ã‚°ãƒ«ãƒ¼ãƒ—
  filteredPlaylist.forEach(channel => {
    const groupName = channel.group || 'æœªåˆ†é¡';
    if (!groups[groupName]) {
      groups[groupName] = [];
    }
    groups[groupName].push(channel);
  });
  
  // HTMLç”Ÿæˆ
  let html = '';
  for (const [groupName, channels] of Object.entries(groups)) {
    const isCollapsed = collapsedGroups.has(groupName);
    
    html += `
      <div class="playlist-group">
        <div class="group-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleGroup('${groupName}')">
          <span>${groupName} (${channels.length})</span>
          <span class="group-toggle">â–¼</span>
        </div>
        <div class="group-items ${isCollapsed ? 'collapsed' : ''}">
          ${channels.map(channel => createChannelCard(channel)).join('')}
        </div>
      </div>
    `;
  }
  
  elements.playlistContent.innerHTML = html;
}

function createChannelCard(channel) {
  const isPlaying = currentVideo && currentVideo.id === channel.id;
  const isFavorite = favorites.some(fav => fav.id === channel.id);
  const isPinned = pins.some(pin => pin.id === channel.id);
  
  return `
    <div class="playlist-item ${isPlaying ? 'playing' : ''}" onclick="playChannel('${channel.id}')">
      <img class="item-thumbnail" src="${channel.logo}" alt="${channel.title}" 
           onerror="this.src='https://via.placeholder.com/280x120/007aff/ffffff?text=ğŸ“º'" />
      <div class="item-content">
        <div class="item-title">${channel.title}</div>
        <div class="item-group">${channel.group}</div>
        ${premium ? `
          <div class="item-actions">
            <button class="item-action ${isFavorite ? 'active' : ''}" 
                    onclick="event.stopPropagation(); toggleFavorite('${channel.id}')"
                    title="ãŠæ°—ã«å…¥ã‚Š">
              ${isFavorite ? 'â­' : 'â˜†'}
            </button>
            <button class="item-action ${isPinned ? 'active' : ''}" 
                    onclick="event.stopPropagation(); togglePin('${channel.id}')"
                    title="ãƒ”ãƒ³ç•™ã‚">
              ${isPinned ? 'ğŸ“Œ' : 'ğŸ“'}
            </button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

// ãƒãƒ£ãƒ³ãƒãƒ«å†ç”Ÿ
function playChannel(channelId) {
  const channel = currentPlaylist.find(ch => ch.id === channelId);
  if (!channel) return;
  
  currentVideo = channel;
  elements.videoPlayer.src = channel.url;
  elements.videoOverlay.classList.remove('show');
  
  // å†ç”Ÿæƒ…å ±æ›´æ–°
  elements.nowPlayingTitle.textContent = channel.title;
  elements.nowPlayingInfo.textContent = `${channel.group} â€¢ å†ç”Ÿä¸­`;
  
  // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè¡¨ç¤ºæ›´æ–°
  renderPlaylist();
  
  log(`å†ç”Ÿé–‹å§‹: ${channel.title}`, 'success');
  showToast(`å†ç”Ÿé–‹å§‹: ${channel.title}`, 'success');
  
  // è‡ªå‹•å†ç”Ÿ
  elements.videoPlayer.play().catch(error => {
    log(`è‡ªå‹•å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    showToast('è‡ªå‹•å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å†ç”Ÿã—ã¦ãã ã•ã„ã€‚', 'warning');
  });
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
function createFilters() {
  const groups = [...new Set(currentPlaylist.map(ch => ch.group))].sort();
  
  if (groups.length <= 1) {
    elements.playlistFilters.style.display = 'none';
    return;
  }
  
  elements.playlistFilters.style.display = 'flex';
  elements.playlistFilters.innerHTML = `
    <div class="filter-chip active" onclick="filterByGroup('')">
      ã™ã¹ã¦ (${currentPlaylist.length})
    </div>
    ${groups.map(group => {
      const count = currentPlaylist.filter(ch => ch.group === group).length;
      return `
        <div class="filter-chip" onclick="filterByGroup('${group}')">
          ${group} (${count})
        </div>
      `;
    }).join('')}
  `;
}

function filterByGroup(group) {
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒƒãƒ—ã®çŠ¶æ…‹æ›´æ–°
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  if (group === '') {
    filteredPlaylist = [...currentPlaylist];
  } else {
    filteredPlaylist = currentPlaylist.filter(ch => ch.group === group);
  }
  
  // æ¤œç´¢ã‚‚é©ç”¨
  const searchTerm = elements.searchInput.value.toLowerCase();
  if (searchTerm) {
    filteredPlaylist = filteredPlaylist.filter(ch => 
      ch.title.toLowerCase().includes(searchTerm)
    );
  }
  
  renderPlaylist();
  updateStats();
}

// æ¤œç´¢æ©Ÿèƒ½
function setupSearch() {
  let searchTimeout;
  
  elements.searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const searchTerm = e.target.value.toLowerCase();
      
      if (searchTerm === '') {
        filteredPlaylist = [...currentPlaylist];
      } else {
        filteredPlaylist = currentPlaylist.filter(channel =>
          channel.title.toLowerCase().includes(searchTerm) ||
          channel.group.toLowerCase().includes(searchTerm)
        );
      }
      
      renderPlaylist();
      updateStats();
      
      log(`æ¤œç´¢: "${searchTerm}" - ${filteredPlaylist.length}ä»¶ã®çµæœ`);
    }, 300);
  });
}

// ã‚°ãƒ«ãƒ¼ãƒ—æŠ˜ã‚ŠãŸãŸã¿
function toggleGroup(groupName) {
  if (collapsedGroups.has(groupName)) {
    collapsedGroups.delete(groupName);
  } else {
    collapsedGroups.add(groupName);
  }
  renderPlaylist();
}

// ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½
function toggleFavorite(channelId) {
  const channel = currentPlaylist.find(ch => ch.id === channelId);
  if (!channel) return;
  
  const index = favorites.findIndex(fav => fav.id === channelId);
  
  if (index >= 0) {
    favorites.splice(index, 1);
    showToast(`ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤: ${channel.title}`, 'info');
  } else {
    favorites.push(channel);
    showToast(`ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ : ${channel.title}`, 'success');
  }
  
  localStorage.setItem('favorites', JSON.stringify(favorites));
  renderPlaylist();
}

// ãƒ”ãƒ³ç•™ã‚æ©Ÿèƒ½
function togglePin(channelId) {
  const channel = currentPlaylist.find(ch => ch.id === channelId);
  if (!channel) return;
  
  const index = pins.findIndex(pin => pin.id === channelId);
  
  if (index >= 0) {
    pins.splice(index, 1);
    showToast(`ãƒ”ãƒ³ç•™ã‚ã‚’è§£é™¤: ${channel.title}`, 'info');
  } else {
    pins.push(channel);
    showToast(`ãƒ”ãƒ³ç•™ã‚ã«è¿½åŠ : ${channel.title}`, 'success');
  }
  
  localStorage.setItem('pins', JSON.stringify(pins));
  renderPlaylist();
}

// çµ±è¨ˆæ›´æ–°
function updateStats() {
  const total = currentPlaylist.length;
  const filtered = filteredPlaylist.length;
  
  if (total === filtered) {
    elements.playlistStats.textContent = `ãƒãƒ£ãƒ³ãƒãƒ«æ•°: ${total}`;
  } else {
    elements.playlistStats.textContent = `ãƒãƒ£ãƒ³ãƒãƒ«æ•°: ${filtered} / ${total}`;
  }
}

// ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½è§£é™¤
function unlockPremium() {
  const code = prompt('ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
  
  if (code === '0429') {
    premium = true;
    localStorage.setItem('premium', 'true');
    elements.premiumUnlock.textContent = 'âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ';
    elements.premiumUnlock.classList.remove('btn-success');
    elements.premiumUnlock.classList.add('btn-secondary');
    
    showToast('ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼', 'success');
    renderPlaylist();
  } else if (code !== null) {
    showToast('ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™', 'error');
  }
}

// ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¤ãƒ³ãƒ”ã‚¯ãƒãƒ£ãƒ¼
function togglePiP() {
  if (document.pictureInPictureElement) {
    document.exitPictureInPicture();
  } else if (elements.videoPlayer.requestPictureInPicture) {
    elements.videoPlayer.requestPictureInPicture()
      .then(() => {
        showToast('ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¤ãƒ³ãƒ”ã‚¯ãƒãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹', 'success');
      })
      .catch(error => {
        showToast('ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¤ãƒ³ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
      });
  }
}

// ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
function toggleFullscreen() {
  if (document.fullscreenElement) {
    document.exitFullscreen();
  } else {
    elements.videoPlayer.requestFullscreen()
      .then(() => {
        showToast('ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹', 'success');
      })
      .catch(error => {
        showToast('ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
      });
  }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
function setupEventListeners() {
  // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  elements.fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (evt) => {
      parseM3U(evt.target.result);
    };
    reader.onerror = () => {
      showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    };
    reader.readAsText(file);
  });
  
  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  elements.debugToggle.addEventListener('click', toggleDebug);
  elements.premiumUnlock.addEventListener('click', unlockPremium);
  elements.pipButton.addEventListener('click', togglePiP);
  elements.fullscreenButton.addEventListener('click', toggleFullscreen);
  
  // ãƒ“ãƒ‡ã‚ªã‚¤ãƒ™ãƒ³ãƒˆ
  elements.videoPlayer.addEventListener('loadstart', () => {
    elements.videoOverlay.classList.add('show');
    elements.videoOverlay.innerHTML = '<div class="spinner"></div><div>èª­ã¿è¾¼ã¿ä¸­...</div>';
  });
  
  elements.videoPlayer.addEventListener('canplay', () => {
    elements.videoOverlay.classList.remove('show');
  });
  
  elements.videoPlayer.addEventListener('error', (e) => {
    showToast('å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    elements.videoOverlay.classList.add('show');
    elements.videoOverlay.innerHTML = '<div>âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
  });
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    
    switch (e.key) {
      case ' ':
        e.preventDefault();
        if (elements.videoPlayer.paused) {
          elements.videoPlayer.play();
        } else {
          elements.videoPlayer.pause();
        }
        break;
      case 'f':
      case 'F':
        e.preventDefault();
        toggleFullscreen();
        break;
      case 'p':
      case 'P':
        e.preventDefault();
        togglePiP();
        break;
    }
  });
}

// åˆæœŸåŒ–
function init() {
  log('M3U Player Pro ã‚’åˆæœŸåŒ–ä¸­...');
  
  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã®ç¢ºèª
  if (premium) {
    elements.premiumUnlock.textContent = 'âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ';
    elements.premiumUnlock.classList.remove('btn-success');
    elements.premiumUnlock.classList.add('btn-secondary');
  }
  
  // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
  elements.videoOverlay.classList.add('show');
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  setupEventListeners();
  setupSearch();
  
  log('åˆæœŸåŒ–å®Œäº†', 'success');
  showToast('M3U Player Pro ã¸ã‚ˆã†ã“ãï¼', 'success');
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', init);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLå†…ã®onclickã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
window.toggleGroup = toggleGroup;
window.filterByGroup = filterByGroup;
window.playChannel = playChannel;
window.toggleFavorite = toggleFavorite;
window.togglePin = togglePin;
window.hideToast = hideToast;
window.toggleDebug = toggleDebug;
</script>

</body>
</html>
