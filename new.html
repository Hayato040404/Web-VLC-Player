<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>üé¨ M3U Player Pro - Á©∂Ê•µ„ÅÆ„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞‰ΩìÈ®ì</title>
<style>
  /* „Éô„Éº„Çπ„É™„Çª„ÉÉ„Éà */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  
  :root {
    --primary-color: #007aff;
    --secondary-color: #34c759;
    --accent-color: #ff9500;
    --danger-color: #ff3b30;
    --background-primary: #f2f2f7;
    --background-secondary: #ffffff;
    --text-primary: #1c1c1e;
    --text-secondary: #8e8e93;
    --border-color: #d1d1d6;
    --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
    --shadow-medium: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-heavy: 0 8px 24px rgba(0,0,0,0.15);
    --border-radius: 16px;
    --border-radius-large: 24px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  html, body {
    height: 100%;
    background: var(--background-primary);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* „Éò„ÉÉ„ÉÄ„Éº */
  .header {
    background: var(--background-secondary);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 16px 20px;
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
  }

  .logo {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* Ê§úÁ¥¢„Éê„Éº */
  .search-container {
    position: relative;
    flex: 1;
    max-width: 400px;
    margin: 0 20px;
  }

  .search-input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-secondary);
    font-size: 1rem;
    transition: var(--transition);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  /* „Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
  .btn {
    padding: 10px 16px;
    border-radius: var(--border-radius);
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-light);
  }

  .btn-primary:hover {
    background: #005ecb;
    box-shadow: var(--shadow-medium);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--background-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .btn-secondary:hover {
    background: #f8f8f8;
    border-color: var(--primary-color);
  }

  .btn-success {
    background: var(--secondary-color);
    color: white;
  }

  .btn-success:hover {
    background: #28a745;
  }

  /* „Éï„Ç°„Ç§„É´ÂÖ•Âäõ */
  .file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
  }

  .file-input {
    position: absolute;
    left: -9999px;
  }

  /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
  .main-content {
    flex: 1;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
    padding: 20px;
  }

  /* „Éó„É¨„Ç§„É§„Éº„Çª„ÇØ„Ç∑„Éß„É≥ */
  .player-section {
    background: var(--background-secondary);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-medium);
    margin-bottom: 24px;
    overflow: hidden;
  }

  .player-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .now-playing {
    flex: 1;
  }

  .now-playing-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .now-playing-info {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .player-controls {
    display: flex;
    gap: 8px;
  }

  .video-container {
    position: relative;
    background: #000;
  }

  .video-player {
    width: 100%;
    height: auto;
    min-height: 300px;
    display: block;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    opacity: 0;
    transition: var(--transition);
    pointer-events: none;
  }

  .video-overlay.show {
    opacity: 1;
  }

  /* „Éó„É¨„Ç§„É™„Çπ„Éà„Çª„ÇØ„Ç∑„Éß„É≥ */
  .playlist-section {
    background: var(--background-secondary);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-medium);
    overflow: hidden;
  }

  .playlist-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .playlist-title {
    font-size: 1.3rem;
    font-weight: 700;
  }

  .playlist-stats {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .playlist-filters {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .filter-chip {
    padding: 6px 12px;
    border-radius: 20px;
    background: var(--background-primary);
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    cursor: pointer;
    transition: var(--transition);
  }

  .filter-chip.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .filter-chip:hover:not(.active) {
    background: #e8e8ed;
  }

  /* „Éó„É¨„Ç§„É™„Çπ„Éà„Ç¢„Ç§„ÉÜ„É† */
  .playlist-content {
    max-height: 600px;
    overflow-y: auto;
  }

  .playlist-group {
    border-bottom: 1px solid var(--border-color);
  }

  .group-header {
    padding: 16px 24px;
    background: var(--background-primary);
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .group-toggle {
    transition: var(--transition);
  }

  .group-header.collapsed .group-toggle {
    transform: rotate(-90deg);
  }

  .group-items {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    padding: 16px 24px;
  }

  .group-items.collapsed {
    display: none;
  }

  .playlist-item {
    background: var(--background-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .playlist-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-color);
  }

  .playlist-item.playing {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
  }

  .item-thumbnail {
    width: 100%;
    height: 120px;
    object-fit: cover;
    background: var(--background-primary);
  }

  .item-content {
    padding: 12px;
  }

  .item-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 4px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .item-group {
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-bottom: 8px;
  }

  .item-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .item-action {
    padding: 4px 8px;
    border-radius: 8px;
    border: none;
    background: var(--background-primary);
    color: var(--text-secondary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: var(--transition);
  }

  .item-action:hover {
    background: var(--primary-color);
    color: white;
  }

  .item-action.active {
    background: var(--accent-color);
    color: white;
  }

  /* Á©∫„ÅÆÁä∂ÊÖã */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .empty-description {
    font-size: 0.9rem;
    line-height: 1.5;
  }

  /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-color);
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 12px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--background-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 16px 20px;
    box-shadow: var(--shadow-heavy);
    z-index: 1000;
    transform: translateX(400px);
    transition: var(--transition);
    max-width: 300px;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .toast-icon {
    font-size: 1.2rem;
  }

  .toast-message {
    flex: 1;
    font-size: 0.9rem;
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1rem;
  }

  /* „Éá„Éê„ÉÉ„Ç∞„Ç≥„É≥„ÇΩ„Éº„É´ */
  .debug-console {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 400px;
    max-height: 300px;
    background: #1a1a1a;
    color: #00ff00;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 0.8rem;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-heavy);
    z-index: 999;
    transform: translateY(400px);
    transition: var(--transition);
  }

  .debug-console.show {
    transform: translateY(0);
  }

  .debug-header {
    background: #333;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
  }

  .debug-content {
    padding: 12px;
    max-height: 240px;
    overflow-y: auto;
    white-space: pre-wrap;
    line-height: 1.4;
  }

  /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      gap: 12px;
    }

    .search-container {
      order: 3;
      max-width: none;
      margin: 0;
    }

    .header-actions {
      order: 2;
      width: 100%;
      justify-content: space-between;
    }

    .main-content {
      padding: 16px;
    }

    .group-items {
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 12px 16px;
    }

    .playlist-header,
    .player-header {
      padding: 16px;
    }

    .playlist-filters {
      padding: 12px 16px;
    }

    .debug-console {
      width: calc(100vw - 40px);
      left: 20px;
      right: 20px;
    }

    .toast {
      right: 20px;
      left: 20px;
      max-width: none;
    }
  }

  @media (max-width: 480px) {
    .btn {
      padding: 8px 12px;
      font-size: 0.8rem;
    }

    .logo {
      font-size: 1.3rem;
    }

    .playlist-title {
      font-size: 1.1rem;
    }

    .item-content {
      padding: 10px;
    }
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <div class="logo">
      üé¨ M3U Player Pro
    </div>
    
    <div class="search-container">
      <div class="search-icon">üîç</div>
      <input type="text" class="search-input" id="searchInput" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÇíÊ§úÁ¥¢..." />
    </div>
    
    <div class="header-actions">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" class="file-input" accept=".m3u,.m3u8" />
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
          üìÅ „Éó„É¨„Ç§„É™„Çπ„ÉàË™≠„ÅøËæº„Åø
        </button>
      </div>
      
      <button class="btn btn-secondary" id="debugToggle">
        üêõ „Éá„Éê„ÉÉ„Ç∞
      </button>
      
      <button class="btn btn-success" id="premiumUnlock">
        üîê „Éó„É¨„Éü„Ç¢„É†
      </button>
    </div>
  </div>
</header>

<main class="main-content">
  <!-- „Éó„É¨„Ç§„É§„Éº„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <section class="player-section">
    <div class="player-header">
      <div class="now-playing">
        <div class="now-playing-title" id="nowPlayingTitle">„Éó„É¨„Ç§„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
        <div class="now-playing-info" id="nowPlayingInfo">„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åô„Çã„Å®ÂÜçÁîü„ÅåÈñãÂßã„Åï„Çå„Åæ„Åô</div>
      </div>
      <div class="player-controls">
        <button class="btn btn-secondary" id="pipButton" title="„Éî„ÇØ„ÉÅ„É£„Éº„Ç§„É≥„Éî„ÇØ„ÉÅ„É£„Éº">
          üì∫ PIP
        </button>
        <button class="btn btn-secondary" id="fullscreenButton" title="„Éï„É´„Çπ„ÇØ„É™„Éº„É≥">
          ‚õ∂ ÂÖ®ÁîªÈù¢
        </button>
      </div>
    </div>
    
    <div class="video-container">
      <video id="videoPlayer" class="video-player" controls preload="auto" playsinline></video>
      <div class="video-overlay" id="videoOverlay">
        <div>üì∫ „ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åó„Å¶ÂÜçÁîü„ÇíÈñãÂßã</div>
      </div>
    </div>
  </section>

  <!-- „Éó„É¨„Ç§„É™„Çπ„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <section class="playlist-section">
    <div class="playlist-header">
      <div>
        <div class="playlist-title">„Éó„É¨„Ç§„É™„Çπ„Éà</div>
        <div class="playlist-stats" id="playlistStats">„ÉÅ„É£„É≥„Éç„É´Êï∞: 0</div>
      </div>
    </div>
    
    <div class="playlist-filters" id="playlistFilters" style="display: none;">
      <!-- „Éï„Ç£„É´„Çø„Éº„ÉÅ„ÉÉ„Éó„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
    </div>
    
    <div class="playlist-content" id="playlistContent">
      <div class="empty-state">
        <div class="empty-icon">üì∫</div>
        <div class="empty-title">„Éó„É¨„Ç§„É™„Çπ„Éà„ÅåÁ©∫„Åß„Åô</div>
        <div class="empty-description">
          M3U„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„ÄÅ„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„ÉÅ„É£„É≥„Éç„É´„ÇíÊ•Ω„Åó„Åø„Åæ„Åó„Çá„ÅÜÔºÅ<br>
          „Éï„Ç°„Ç§„É´„ÅØ‰∏äÈÉ®„ÅÆ„Äå„Éó„É¨„Ç§„É™„Çπ„ÉàË™≠„ÅøËæº„Åø„Äç„Éú„Çø„É≥„Åã„ÇâÈÅ∏Êäû„Åß„Åç„Åæ„Åô„ÄÇ
        </div>
      </div>
    </div>
  </section>
</main>

<!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
<div class="toast" id="toast">
  <div class="toast-content">
    <div class="toast-icon" id="toastIcon">‚ÑπÔ∏è</div>
    <div class="toast-message" id="toastMessage"></div>
    <button class="toast-close" onclick="hideToast()">√ó</button>
  </div>
</div>

<!-- „Éá„Éê„ÉÉ„Ç∞„Ç≥„É≥„ÇΩ„Éº„É´ -->
<div class="debug-console" id="debugConsole">
  <div class="debug-header">
    <span>üêõ „Éá„Éê„ÉÉ„Ç∞„Ç≥„É≥„ÇΩ„Éº„É´</span>
    <button class="toast-close" onclick="toggleDebug()" style="color: #fff;">√ó</button>
  </div>
  <div class="debug-content" id="debugContent"></div>
</div>

<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentPlaylist = [];
let filteredPlaylist = [];
let currentVideo = null;
let premium = localStorage.getItem('premium') === 'true';
let debug = false;
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
let pins = JSON.parse(localStorage.getItem('pins') || '[]');
let collapsedGroups = new Set();

// DOMË¶ÅÁ¥†
const elements = {
  fileInput: document.getElementById('fileInput'),
  searchInput: document.getElementById('searchInput'),
  debugToggle: document.getElementById('debugToggle'),
  premiumUnlock: document.getElementById('premiumUnlock'),
  pipButton: document.getElementById('pipButton'),
  fullscreenButton: document.getElementById('fullscreenButton'),
  videoPlayer: document.getElementById('videoPlayer'),
  videoOverlay: document.getElementById('videoOverlay'),
  nowPlayingTitle: document.getElementById('nowPlayingTitle'),
  nowPlayingInfo: document.getElementById('nowPlayingInfo'),
  playlistContent: document.getElementById('playlistContent'),
  playlistStats: document.getElementById('playlistStats'),
  playlistFilters: document.getElementById('playlistFilters'),
  toast: document.getElementById('toast'),
  toastIcon: document.getElementById('toastIcon'),
  toastMessage: document.getElementById('toastMessage'),
  debugConsole: document.getElementById('debugConsole'),
  debugContent: document.getElementById('debugContent')
};

// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
function log(message, type = 'info') {
  if (!debug) return;
  
  const timestamp = new Date().toLocaleTimeString();
  const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
  const icon = icons[type] || icons.info;
  
  elements.debugContent.textContent += `[${timestamp}] ${icon} ${message}\n`;
  elements.debugContent.scrollTop = elements.debugContent.scrollHeight;
}

function showToast(message, type = 'info', duration = 3000) {
  const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
  
  elements.toastIcon.textContent = icons[type] || icons.info;
  elements.toastMessage.textContent = message;
  elements.toast.classList.add('show');
  
  setTimeout(() => {
    elements.toast.classList.remove('show');
  }, duration);
  
  log(message, type);
}

function hideToast() {
  elements.toast.classList.remove('show');
}

function toggleDebug() {
  debug = !debug;
  elements.debugConsole.classList.toggle('show', debug);
  elements.debugToggle.textContent = debug ? 'üêõ „Éá„Éê„ÉÉ„Ç∞ OFF' : 'üêõ „Éá„Éê„ÉÉ„Ç∞';
  
  if (debug) {
    log('„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü');
  }
}

// „Éó„É¨„Ç§„É™„Çπ„ÉàËß£Êûê
function parseM3U(content) {
  const lines = content.split('\n').map(line => line.trim()).filter(line => line);
  const channels = [];
  let currentChannel = {};
  
  log('M3U„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„ÇíÈñãÂßã');
  
  for (const line of lines) {
    if (line.startsWith('#EXTINF:')) {
      // „ÉÅ„É£„É≥„Éç„É´ÊÉÖÂ†±„ÅÆÊäΩÂá∫
      const titleMatch = line.match(/,(.+)$/);
      const logoMatch = line.match(/tvg-logo="([^"]+)"/);
      const groupMatch = line.match(/group-title="([^"]+)"/);
      const idMatch = line.match(/tvg-id="([^"]+)"/);
      
      currentChannel = {
        id: idMatch ? idMatch[1] : `channel_${channels.length}`,
        title: titleMatch ? titleMatch[1].trim() : `„ÉÅ„É£„É≥„Éç„É´ ${channels.length + 1}`,
        logo: logoMatch ? logoMatch[1] : 'https://via.placeholder.com/160x90/007aff/ffffff?text=üì∫',
        group: groupMatch ? groupMatch[1] : 'Êú™ÂàÜÈ°û',
        url: ''
      };
    } else if (line.startsWith('http')) {
      currentChannel.url = line;
      channels.push({ ...currentChannel });
      currentChannel = {};
    }
  }
  
  currentPlaylist = channels;
  filteredPlaylist = [...channels];
  
  log(`${channels.length}ÂÄã„ÅÆ„ÉÅ„É£„É≥„Éç„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'success');
  showToast(`${channels.length}ÂÄã„ÅÆ„ÉÅ„É£„É≥„Éç„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'success');
  
  renderPlaylist();
  updateStats();
  createFilters();
}

// „Éó„É¨„Ç§„É™„Çπ„ÉàË°®Á§∫
function renderPlaylist() {
  if (filteredPlaylist.length === 0) {
    elements.playlistContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <div class="empty-title">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>
        <div class="empty-description">
          Ê§úÁ¥¢Êù°‰ª∂„ÇíÂ§âÊõ¥„Åô„Çã„Åã„ÄÅ„Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </div>
      </div>
    `;
    return;
  }
  
  // „Ç∞„É´„Éº„ÉóÂà•„Å´Êï¥ÁêÜ
  const groups = {};
  
  // „Éó„É¨„Éü„Ç¢„É†Ê©üËÉΩ: „Éî„É≥Áïô„ÇÅ„Å®„ÅäÊ∞ó„Å´ÂÖ•„Çä
  if (premium) {
    const pinnedChannels = filteredPlaylist.filter(channel => 
      pins.some(pin => pin.id === channel.id)
    );
    const favoriteChannels = filteredPlaylist.filter(channel => 
      favorites.some(fav => fav.id === channel.id)
    );
    
    if (pinnedChannels.length > 0) {
      groups['üìå „Éî„É≥Áïô„ÇÅ'] = pinnedChannels;
    }
    if (favoriteChannels.length > 0) {
      groups['‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä'] = favoriteChannels;
    }
  }
  
  // ÈÄöÂ∏∏„ÅÆ„Ç∞„É´„Éº„Éó
  filteredPlaylist.forEach(channel => {
    const groupName = channel.group || 'Êú™ÂàÜÈ°û';
    if (!groups[groupName]) {
      groups[groupName] = [];
    }
    groups[groupName].push(channel);
  });
  
  // HTMLÁîüÊàê
  let html = '';
  for (const [groupName, channels] of Object.entries(groups)) {
    const isCollapsed = collapsedGroups.has(groupName);
    
    html += `
      <div class="playlist-group">
        <div class="group-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleGroup('${groupName}')">
          <span>${groupName} (${channels.length})</span>
          <span class="group-toggle">‚ñº</span>
        </div>
        <div class="group-items ${isCollapsed ? 'collapsed' : ''}">
          ${channels.map(channel => createChannelCard(channel)).join('')}
        </div>
      </div>
    `;
  }
  
  elements.playlistContent.innerHTML = html;
}

function createChannelCard(channel) {
  const isPlaying = currentVideo && currentVideo.id === channel.id;
  const isFavorite = favorites.some(fav => fav.id === channel.id);
  const isPinned = pins.some(pin => pin.id === channel.id);
  
  return `
    <div class="playlist-item ${isPlaying ? 'playing' : ''}" onclick="playChannel('${channel.id}')">
      <img class="item-thumbnail" src="${channel.logo}" alt="${channel.title}" 
           onerror="this.src='https://via.placeholder.com/280x120/007aff/ffffff?text=üì∫'" />
      <div class="item-content">
        <div class="item-title">${channel.title}</div>
        <div class="item-group">${channel.group}</div>
        ${premium ? `
          <div class="item-actions">
            <button class="item-action ${isFavorite ? 'active' : ''}" 
                    onclick="event.stopPropagation(); toggleFavorite('${channel.id}')"
                    title="„ÅäÊ∞ó„Å´ÂÖ•„Çä">
              ${isFavorite ? '‚≠ê' : '‚òÜ'}
            </button>
            <button class="item-action ${isPinned ? 'active' : ''}" 
                    onclick="event.stopPropagation(); togglePin('${channel.id}')"
                    title="„Éî„É≥Áïô„ÇÅ">
              ${isPinned ? 'üìå' : 'üìç'}
            </button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

// „ÉÅ„É£„É≥„Éç„É´ÂÜçÁîü
function playChannel(channelId) {
  const channel = currentPlaylist.find(ch => ch.id === channelId);
  if (!channel) return;
  
  currentVideo = channel;
  elements.videoPlayer.src = channel.url;
  elements.videoOverlay.classList.remove('show');
  
  // ÂÜçÁîüÊÉÖÂ†±Êõ¥Êñ∞
  elements.nowPlayingTitle.textContent = channel.title;
  elements.nowPlayingInfo.textContent = `${channel.group} ‚Ä¢ ÂÜçÁîü‰∏≠`;
  
  // „Éó„É¨„Ç§„É™„Çπ„ÉàË°®Á§∫Êõ¥Êñ∞
  renderPlaylist();
  
  log(`ÂÜçÁîüÈñãÂßã: ${channel.title}`, 'success');
  showToast(`ÂÜçÁîüÈñãÂßã: ${channel.title}`, 'success');
  
  // Ëá™ÂãïÂÜçÁîü
  elements.videoPlayer.play().catch(error => {
    log(`Ëá™ÂãïÂÜçÁîü„Ç®„É©„Éº: ${error.message}`, 'error');
    showToast('Ëá™ÂãïÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„ÅßÂÜçÁîü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
  });
}

// „Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ
function createFilters() {
  const groups = [...new Set(currentPlaylist.map(ch => ch.group))].sort();
  
  if (groups.length <= 1) {
    elements.playlistFilters.style.display = 'none';
    return;
  }
  
  elements.playlistFilters.style.display = 'flex';
  elements.playlistFilters.innerHTML = `
    <div class="filter-chip active" onclick="filterByGroup('')">
      „Åô„Åπ„Å¶ (${currentPlaylist.length})
    </div>
    ${groups.map(group => {
      const count = currentPlaylist.filter(ch => ch.group === group).length;
      return `
        <div class="filter-chip" onclick="filterByGroup('${group}')">
          ${group} (${count})
        </div>
      `;
    }).join('')}
  `;
}

function filterByGroup(group) {
  // „Éï„Ç£„É´„Çø„Éº„ÉÅ„ÉÉ„Éó„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // „Éó„É¨„Ç§„É™„Çπ„Éà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
  if (group === '') {
    filteredPlaylist = [...currentPlaylist];
  } else {
    filteredPlaylist = currentPlaylist.filter(ch => ch.group === group);
  }
  
  // Ê§úÁ¥¢„ÇÇÈÅ©Áî®
  const searchTerm = elements.searchInput.value.toLowerCase();
  if (searchTerm) {
    filteredPlaylist = filteredPlaylist.filter(ch => 
      ch.title.toLowerCase().includes(searchTerm)
    );
  }
  
  renderPlaylist();
  updateStats();
}

// Ê§úÁ¥¢Ê©üËÉΩ
function setupSearch() {
  let searchTimeout;
  
  elements.searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const searchTerm = e.target.value.toLowerCase();
      
      if (searchTerm === '') {
        filteredPlaylist = [...currentPlaylist];
      } else {
        filteredPlaylist = currentPlaylist.filter(channel =>
          channel.title.toLowerCase().includes(searchTerm) ||
          channel.group.toLowerCase().includes(searchTerm)
        );
      }
      
      renderPlaylist();
      updateStats();
      
      log(`Ê§úÁ¥¢: "${searchTerm}" - ${filteredPlaylist.length}‰ª∂„ÅÆÁµêÊûú`);
    }, 300);
  });
}

// „Ç∞„É´„Éº„ÉóÊäò„Çä„Åü„Åü„Åø
function toggleGroup(groupName) {
  if (collapsedGroups.has(groupName)) {
    collapsedGroups.delete(groupName);
  } else {
    collapsedGroups.add(groupName);
  }
  renderPlaylist();
}

// „ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ©üËÉΩ
function toggleFavorite(channelId) {
  const channel = currentPlaylist.find(ch => ch.id === channelId);
  if (!channel) return;
  
  const index = favorites.findIndex(fav => fav.id === channelId);
  
  if (index >= 0) {
    favorites.splice(index, 1);
    showToast(`„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§: ${channel.title}`, 'info');
  } else {
    favorites.push(channel);
    showToast(`„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†: ${channel.title}`, 'success');
  }
  
  localStorage.setItem('favorites', JSON.stringify(favorites));
  renderPlaylist();
}

// „Éî„É≥Áïô„ÇÅÊ©üËÉΩ
function togglePin(channelId) {
  const channel = currentPlaylist.find(ch => ch.id === channelId);
  if (!channel) return;
  
  const index = pins.findIndex(pin => pin.id === channelId);
  
  if (index >= 0) {
    pins.splice(index, 1);
    showToast(`„Éî„É≥Áïô„ÇÅ„ÇíËß£Èô§: ${channel.title}`, 'info');
  } else {
    pins.push(channel);
    showToast(`„Éî„É≥Áïô„ÇÅ„Å´ËøΩÂä†: ${channel.title}`, 'success');
  }
  
  localStorage.setItem('pins', JSON.stringify(pins));
  renderPlaylist();
}

// Áµ±Ë®àÊõ¥Êñ∞
function updateStats() {
  const total = currentPlaylist.length;
  const filtered = filteredPlaylist.length;
  
  if (total === filtered) {
    elements.playlistStats.textContent = `„ÉÅ„É£„É≥„Éç„É´Êï∞: ${total}`;
  } else {
    elements.playlistStats.textContent = `„ÉÅ„É£„É≥„Éç„É´Êï∞: ${filtered} / ${total}`;
  }
}

// „Éó„É¨„Éü„Ç¢„É†Ê©üËÉΩËß£Èô§
function unlockPremium() {
  const code = prompt('„Éó„É¨„Éü„Ç¢„É†„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
  
  if (code === '0429') {
    premium = true;
    localStorage.setItem('premium', 'true');
    elements.premiumUnlock.textContent = '‚úÖ „Éó„É¨„Éü„Ç¢„É†';
    elements.premiumUnlock.classList.remove('btn-success');
    elements.premiumUnlock.classList.add('btn-secondary');
    
    showToast('„Éó„É¨„Éü„Ç¢„É†Ê©üËÉΩ„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ', 'success');
    renderPlaylist();
  } else if (code !== null) {
    showToast('ÁÑ°Âäπ„Å™„Ç≥„Éº„Éâ„Åß„Åô', 'error');
  }
}

// „Éî„ÇØ„ÉÅ„É£„Éº„Ç§„É≥„Éî„ÇØ„ÉÅ„É£„Éº
function togglePiP() {
  if (document.pictureInPictureElement) {
    document.exitPictureInPicture();
  } else if (elements.videoPlayer.requestPictureInPicture) {
    elements.videoPlayer.requestPictureInPicture()
      .then(() => {
        showToast('„Éî„ÇØ„ÉÅ„É£„Éº„Ç§„É≥„Éî„ÇØ„ÉÅ„É£„Éº„É¢„Éº„Éâ„ÇíÈñãÂßã', 'success');
      })
      .catch(error => {
        showToast('„Éî„ÇØ„ÉÅ„É£„Éº„Ç§„É≥„Éî„ÇØ„ÉÅ„É£„Éº„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
      });
  }
}

// „Éï„É´„Çπ„ÇØ„É™„Éº„É≥
function toggleFullscreen() {
  if (document.fullscreenElement) {
    document.exitFullscreen();
  } else {
    elements.videoPlayer.requestFullscreen()
      .then(() => {
        showToast('„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„É¢„Éº„Éâ„ÇíÈñãÂßã', 'success');
      })
      .catch(error => {
        showToast('„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
      });
  }
}

// „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
function setupEventListeners() {
  // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
  elements.fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (evt) => {
      parseM3U(evt.target.result);
    };
    reader.onerror = () => {
      showToast('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    };
    reader.readAsText(file);
  });
  
  // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
  elements.debugToggle.addEventListener('click', toggleDebug);
  elements.premiumUnlock.addEventListener('click', unlockPremium);
  elements.pipButton.addEventListener('click', togglePiP);
  elements.fullscreenButton.addEventListener('click', toggleFullscreen);
  
  // „Éì„Éá„Ç™„Ç§„Éô„É≥„Éà
  elements.videoPlayer.addEventListener('loadstart', () => {
    elements.videoOverlay.classList.add('show');
    elements.videoOverlay.innerHTML = '<div class="spinner"></div><div>Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
  });
  
  elements.videoPlayer.addEventListener('canplay', () => {
    elements.videoOverlay.classList.remove('show');
  });
  
  elements.videoPlayer.addEventListener('error', (e) => {
    showToast('ÂãïÁîª„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    elements.videoOverlay.classList.add('show');
    elements.videoOverlay.innerHTML = '<div>‚ùå Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</div>';
  });
  
  // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    
    switch (e.key) {
      case ' ':
        e.preventDefault();
        if (elements.videoPlayer.paused) {
          elements.videoPlayer.play();
        } else {
          elements.videoPlayer.pause();
        }
        break;
      case 'f':
      case 'F':
        e.preventDefault();
        toggleFullscreen();
        break;
      case 'p':
      case 'P':
        e.preventDefault();
        togglePiP();
        break;
    }
  });
}

// ÂàùÊúüÂåñ
function init() {
  log('M3U Player Pro „ÇíÂàùÊúüÂåñ‰∏≠...');
  
  // „Éó„É¨„Éü„Ç¢„É†Áä∂ÊÖã„ÅÆÁ¢∫Ë™ç
  if (premium) {
    elements.premiumUnlock.textContent = '‚úÖ „Éó„É¨„Éü„Ç¢„É†';
    elements.premiumUnlock.classList.remove('btn-success');
    elements.premiumUnlock.classList.add('btn-secondary');
  }
  
  // ÂàùÊúüÁä∂ÊÖã„ÅÆË®≠ÂÆö
  elements.videoOverlay.classList.add('show');
  
  // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
  setupEventListeners();
  setupSearch();
  
  log('ÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
  showToast('M3U Player Pro „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ', 'success');
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„Å´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', init);

// „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÔºàHTMLÂÜÖ„ÅÆonclick„Åã„ÇâÂëº„Å≥Âá∫„ÅóÁî®Ôºâ
window.toggleGroup = toggleGroup;
window.filterByGroup = filterByGroup;
window.playChannel = playChannel;
window.toggleFavorite = toggleFavorite;
window.togglePin = togglePin;
window.hideToast = hideToast;
window.toggleDebug = toggleDebug;
</script>

</body>
</html>
